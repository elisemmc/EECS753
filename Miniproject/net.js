
//<![CDATA[

// a few things don't have var in front of them - they update already existing variables the game needs
lanesSide = 1;
patchesAhead = 9;
patchesBehind = 0;
trainIterations = 50000;

var num_inputs = (lanesSide * 2 + 1) * (patchesAhead + patchesBehind);
var num_actions = 5;
var temporal_window = 3;
var network_size = num_inputs * temporal_window + num_actions * temporal_window + num_inputs;

var layer_defs = [];
layer_defs.push({
    type: 'input',
    out_sx: 1,
    out_sy: 1,
    out_depth: network_size
});
layer_defs.push({
    type: 'fc',
    num_neurons: 5,
    activation: 'relu'
});
layer_defs.push({
    type: 'regression',
    num_neurons: num_actions
});

var tdtrainer_options = {
    learning_rate: 0.001,
    momentum: 0.0,
    batch_size: 64,
    l2_decay: 0.01
};

var opt = {};
opt.temporal_window = temporal_window;
opt.experience_size = 3000;
opt.start_learn_threshold = 500;
opt.gamma = 0.7;
opt.learning_steps_total = 10000;
opt.learning_steps_burnin = 1000;
opt.epsilon_min = 0.0;
opt.epsilon_test_time = 0.0;
opt.layer_defs = layer_defs;
opt.tdtrainer_options = tdtrainer_options;

brain = new deepqlearn.Brain(num_inputs, num_actions, opt);

learn = function (state, lastReward) {
    brain.backward(lastReward);
    var action = brain.forward(state);

    draw_net();
    draw_stats();

    return action;
}

//]]>
    
/*###########*/
if (brain) {
brain.value_net.fromJSON({"layers":[{"out_depth":123,"out_sx":1,"out_sy":1,"layer_type":"input"},{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":123,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":123,"w":{"0":0.08351871389011009,"1":-0.2813092747603429,"2":-0.0023684080916068053,"3":0.10936842182421365,"4":-0.35523107148570876,"5":-0.03479115595563298,"6":-0.028694978064362848,"7":-0.296991539289958,"8":0.11124289199248238,"9":0.05889520695759315,"10":0.002477324248021935,"11":0.0681689384101882,"12":0.3044591818306476,"13":0.020046922385942894,"14":0.03587775652932633,"15":0.13307312016819603,"16":-0.12927151101730103,"17":0.18882026295583723,"18":0.24800470637076266,"19":0.05152487296985711,"20":0.06823890896748569,"21":0.1174720594764031,"22":-0.011149547926779186,"23":-0.05339831585751912,"24":0.22725023848183862,"25":0.1668449517583182,"26":0.1656227534264534,"27":-0.11807883924701895,"28":0.0032203123071016916,"29":0.058373469058439105,"30":0.03180790412574733,"31":-0.015900855471380784,"32":-0.012117593139237255,"33":-0.020682824563136974,"34":0.12416225980249988,"35":-0.004219803828973387,"36":-0.066822599567954,"37":-0.023052696282044975,"38":-0.004223399553594642,"39":0.22245737628936077,"40":0.20123705894871532,"41":0.08945758760313796,"42":-0.038158261151965835,"43":0.0735330367187665,"44":0.07493570606843289,"45":0.09398555317621532,"46":0.031004669141031727,"47":0.0850192521536639,"48":0.20890883091811002,"49":0.004664764496557853,"50":0.03519392220596938,"51":0.11822275051761645,"52":0.10525700157902373,"53":0.1327491586646292,"54":0.05647352906239539,"55":0.03610890443501601,"56":-0.033139721888349544,"57":0.02868950206670647,"58":0.029928369938379565,"59":-0.07552024255855358,"60":0.0409019570617005,"61":-0.2341692901650987,"62":0.03956679773350305,"63":-0.09411867221094088,"64":0.004729191679304829,"65":-0.08276108351384594,"66":-0.046120996955987724,"67":-0.10578620445081882,"68":0.008984164975904823,"69":0.006538628220988622,"70":0.06407868957708826,"71":0.09202914140616947,"72":0.1511536909353648,"73":-0.06494791153784703,"74":-0.14603215720699292,"75":0.06235542376423142,"76":-0.007285735218680853,"77":0.10187202013130775,"78":0.09755439828088561,"79":0.04315208958739087,"80":0.01931376099296825,"81":0.10259815252520188,"82":-0.03248872578118812,"83":0.14974843491952555,"84":0.13061669291896477,"85":0.13647443115639135,"86":-0.01758054224328243,"87":0.008849006961663183,"88":-0.0434615190078022,"89":0.0030113435937708442,"90":0.006338498478891074,"91":-0.010247230742092312,"92":0.13817418240385623,"93":0.08014393587108251,"94":-0.03219256817814847,"95":0.08999444888722564,"96":0.023461581233000902,"97":-0.028300868276476383,"98":0.061649865133693194,"99":-0.1422859823500519,"100":-0.03875309530565215,"101":0.031406155505966205,"102":0.08560820928221384,"103":-0.08739841384281546,"104":0.07243174060527842,"105":0.020840237009189827,"106":-0.05813178779048676,"107":0.1922185433852721,"108":-0.015822123032144086,"109":0.10472582129504403,"110":-0.01988881647061304,"111":0.04664010621874695,"112":-0.012084316481153642,"113":-0.12251680330796111,"114":0.019925380709395785,"115":-0.08991184040682013,"116":-0.0267939379616391,"117":-0.06642095227654496,"118":-0.04197439938788455,"119":-0.04734366637207532,"120":-0.047237504188808614,"121":-0.04673815911214796,"122":-0.051417457720086414}},{"sx":1,"sy":1,"depth":123,"w":{"0":-0.036962084604110094,"1":0.12689409157958464,"2":-0.014611038201162817,"3":-0.1295204651775028,"4":-0.012741145152656851,"5":0.09246038850004999,"6":0.07540077404358606,"7":-0.1316998393951343,"8":-0.01603576744318049,"9":-0.10187820336204757,"10":-0.27542421260687516,"11":0.2782411346399013,"12":0.030086763640306265,"13":-0.062245301975471824,"14":0.04151350552841083,"15":-0.0026561970824976757,"16":-0.022530239565721782,"17":0.19617174286548786,"18":0.0012609790827560028,"19":-0.05060880673457417,"20":0.3205113708986475,"21":0.11971767787335859,"22":-0.08420231117985447,"23":0.2240965133004545,"24":-0.15969516772810835,"25":0.19426163204021343,"26":0.13213973093004178,"27":-0.011973928792358897,"28":-0.09645279545648665,"29":-0.0344435141243363,"30":-0.052584611941754004,"31":0.056349750557269346,"32":0.12011532698895558,"33":0.12969758982333932,"34":-0.050819194546439524,"35":0.10696079017693629,"36":-0.10763892878090134,"37":0.17088797293617983,"38":0.13671734237375588,"39":-0.09746932596021275,"40":-0.07418692347474239,"41":0.10433068872616089,"42":-0.0521270803880955,"43":0.006638541482081068,"44":0.1025781938513826,"45":-0.1575593597172459,"46":-0.00946536220970614,"47":-0.0965567276703113,"48":-0.07202743680508861,"49":-0.06003117791073729,"50":0.05388090308554911,"51":-0.04425448329546372,"52":-0.17414882737185097,"53":0.1880658321080986,"54":0.02510482195644305,"55":0.015004504168037768,"56":0.025224171806536546,"57":0.033166437003213575,"58":-0.0139763814493648,"59":-0.1416120982725054,"60":-0.040401032085796644,"61":-0.012137657541095455,"62":-0.1235334799375096,"63":0.159673275305255,"64":0.08108838568431535,"65":0.004774263874515465,"66":-0.00055626150491729,"67":-0.07820499119095023,"68":0.040853446569000904,"69":-0.054505306349664225,"70":0.06331113112797625,"71":-0.009464917713903188,"72":0.1496372677913768,"73":0.19760181847336225,"74":-0.0385431100674603,"75":-0.06738266606234468,"76":0.09627775246306854,"77":-0.0914778762630836,"78":-0.04222101785071716,"79":0.10247773727541605,"80":0.16388280190315657,"81":-0.1089829015386607,"82":0.1603100554966653,"83":-0.04348362867673297,"84":-0.0376118789342855,"85":-0.00337007753196637,"86":-0.12767139522468898,"87":-0.1211028512532281,"88":-0.09437818457778827,"89":-0.02163465397766796,"90":-0.04052733919267384,"91":-0.12784561234829825,"92":-0.15576792771542666,"93":0.07889044053837284,"94":-0.07482838697810662,"95":0.03526486393967956,"96":0.026274875608380963,"97":0.06915396666588483,"98":-0.022024585113244656,"99":-0.05713585022740135,"100":-0.15579579782574168,"101":0.014072875358733165,"102":0.016022899514464235,"103":-0.09724780554171898,"104":0.11995546698683514,"105":-0.11606203637656064,"106":0.024817604927483236,"107":-0.09310541750778258,"108":-0.07570917104686424,"109":-0.03567364019177842,"110":0.007533027772810584,"111":0.10190738365699659,"112":-0.06479189328973387,"113":-0.043087737974376615,"114":0.1364987071007957,"115":0.00180901984595209,"116":-0.07736298638117849,"117":0.0028827813840545447,"118":-0.0050541721003000755,"119":-0.009457072106648055,"120":-0.020409261548296993,"121":-0.007395734105800486,"122":-0.10641932375830399}},{"sx":1,"sy":1,"depth":123,"w":{"0":-0.11178114407127097,"1":0.21545441521906003,"2":-0.0954132677330462,"3":0.08789630823568248,"4":0.07554212562393794,"5":-0.09437578900867923,"6":0.012411482732143864,"7":0.1139607605542008,"8":0.011711301919711042,"9":0.007414934319800311,"10":-0.006581311587625455,"11":0.016017430880421086,"12":-0.03622001890677495,"13":-0.03642079489666955,"14":0.023821801416514823,"15":-0.07584668893940368,"16":-0.08318151850604212,"17":-0.039821299685666924,"18":0.15219145084230998,"19":-0.036614370388521986,"20":0.041276586570643384,"21":-0.14720175757953574,"22":-0.036763319610692215,"23":0.05879954326419346,"24":-0.09179394173274169,"25":-0.06286951650908838,"26":-0.06815081644966,"27":-0.033017338895335466,"28":-0.01231402698351207,"29":-0.10046847255346,"30":-0.003320890010056487,"31":-0.04291791894973881,"32":0.05721833504789387,"33":-0.04837851209483221,"34":-0.03549342538016429,"35":0.11621688852373567,"36":-0.06553148854996628,"37":0.09555396576848706,"38":0.07413095899610012,"39":-0.0007726003545410534,"40":0.08151226292101159,"41":-0.06368349923331448,"42":-0.026546294400936855,"43":-0.02582492760785412,"44":0.015598980725693368,"45":-0.24588275508624716,"46":-0.06097301295854439,"47":0.002176570666324696,"48":0.03428669317963301,"49":-0.04235115048255587,"50":-0.07283276876568369,"51":0.0005203005513883333,"52":-0.06629434469208131,"53":0.052677479412268004,"54":-0.050547388830135646,"55":-0.13745922890213802,"56":0.04364029412688641,"57":-0.021786063606883562,"58":-0.06150896197614207,"59":-0.04415308561090694,"60":-0.04992629846882618,"61":-0.018973162391890726,"62":-0.07501985702624418,"63":-0.06057424349500548,"64":0.006055026705098188,"65":0.04869296229473406,"66":-0.1108272578757237,"67":-0.08837128035425472,"68":-0.14443007207854172,"69":0.014978425635586615,"70":-0.07686452248390907,"71":-0.16918992575761602,"72":-0.13919931060527335,"73":-0.036078105712713186,"74":0.028929226779860186,"75":0.12099299257757211,"76":0.14779469694851607,"77":0.16204215287209708,"78":-0.01734931047646346,"79":0.0762924509089144,"80":0.08803251872623157,"81":-0.08480376581670857,"82":0.0640705905008787,"83":0.07188681232267351,"84":-0.10770375657982126,"85":0.0034522255140521847,"86":0.0178453684063103,"87":0.011939687717325717,"88":-0.030187285947604028,"89":-0.13307778871812384,"90":-0.03511429774663978,"91":-0.15446190902893378,"92":0.016135559864893952,"93":0.1933254301486664,"94":-0.04102757187127232,"95":-0.07232531264747377,"96":0.10678392083856128,"97":0.021700782313955135,"98":0.016909876742579672,"99":0.050002573331497976,"100":-0.03092758565651995,"101":0.0627993586261009,"102":0.002981743416816002,"103":-0.08834288270430689,"104":-0.06162343193366569,"105":0.029818491257824566,"106":0.1538814666025024,"107":-0.0222394063318717,"108":0.030289803323619385,"109":-0.014181065976335784,"110":0.023598761001947167,"111":-0.11484367046578624,"112":0.05695209387793788,"113":0.0377860483438703,"114":-0.15724874528645225,"115":-0.05899761582971571,"116":-0.0036756256979450456,"117":0.08923481439768456,"118":-0.09658039881898832,"119":-0.04464617946398718,"120":0.11355669317043203,"121":0.018795157621547202,"122":0.008560273816163479}},{"sx":1,"sy":1,"depth":123,"w":{"0":0.13549727659012736,"1":0.9466358733861432,"2":0.09886768764027969,"3":0.1335308611534945,"4":0.644222449087765,"5":0.20867726073240175,"6":0.11065304988024077,"7":1.4225302572135892,"8":-0.059300144998810464,"9":0.10045890535636114,"10":1.1250803654975123,"11":0.0017298994439009603,"12":0.21886977267865002,"13":1.2142558291629408,"14":0.20665375741092878,"15":0.015831248374110596,"16":1.2733961210340732,"17":0.0072647395115303165,"18":0.1803825212069194,"19":0.1030128174261468,"20":0.2783722928111761,"21":0.18400417753116785,"22":-0.0445295436789741,"23":-0.03374811573707632,"24":0.07962909475019198,"25":-0.05355999954489537,"26":0.08351640188526228,"27":-0.1536353983872108,"28":0.2084806397670333,"29":-0.10700257865788738,"30":0.027453124108741695,"31":-0.13190451503779768,"32":-0.029785486691032568,"33":-0.09693609653771906,"34":0.3473569522288544,"35":-0.10063546254390275,"36":0.03956479143335517,"37":0.02242437507775274,"38":-0.05765765639182953,"39":0.04226598735880059,"40":0.2084167214266074,"41":0.1615430256151589,"42":0.0003658039947470452,"43":0.21054533445329496,"44":0.10902984281838084,"45":0.06691765211282899,"46":0.019326685965865543,"47":0.09091765274489119,"48":0.0752586680602517,"49":0.029184108634847716,"50":0.059786281671253175,"51":0.08030920373972267,"52":-0.029667863267697884,"53":0.07880054671920299,"54":-0.031059887641525463,"55":-0.006285215313758555,"56":-0.07055465582554586,"57":-0.006565380405584313,"58":-0.009039610627050786,"59":-0.07646793103056608,"60":-0.05603193142479963,"61":-0.11681128248223815,"62":-0.045725053566626435,"63":-0.08875534027075267,"64":0.002829866178337482,"65":-0.08008052323704862,"66":0.0885666659236703,"67":-0.24703071975298757,"68":0.06518017281351125,"69":-0.19210838395378577,"70":0.07548116411707449,"71":-0.07888119219944631,"72":0.15593316064922727,"73":0.03396579412342383,"74":-0.08922979748069619,"75":0.13592107357146993,"76":0.02940629142823667,"77":0.020000134929566624,"78":-0.01923162181738735,"79":-0.07812533985872756,"80":0.1282941493569303,"81":-0.03955841236951401,"82":0.11561897796225154,"83":0.01526341798241237,"84":0.03611184886571099,"85":0.07766474046282473,"86":-0.0344590015544523,"87":-0.01709796616407965,"88":-0.04226635178020021,"89":-0.025014818360051712,"90":-0.023913041175168185,"91":-0.09226190544237033,"92":0.03625283389155368,"93":-0.025537684289058355,"94":0.01972809429576318,"95":-0.1140363591601319,"96":0.054352094925652496,"97":-0.11441581476468389,"98":0.08340760285887436,"99":-0.05641561907065568,"100":0.08659760054907305,"101":-0.03217581022562404,"102":-0.07672737372614184,"103":-0.1097623448971493,"104":-0.03924415844688584,"105":0.06186026603960719,"106":0.022026492971286813,"107":0.1638934243683117,"108":0.081756901470228,"109":-0.0798381497358471,"110":-0.08913778921629407,"111":-0.029642239658608998,"112":0.07656174932937078,"113":-0.1369271294292184,"114":0.005620599777244776,"115":-0.00760257488904401,"116":0.127240211992724,"117":0.00659702780606642,"118":-0.01441389079029337,"119":0.000038897855581211324,"120":-0.035294735421101044,"121":-0.009247338333893358,"122":-0.007180077534022382}},{"sx":1,"sy":1,"depth":123,"w":{"0":0.03553750539201788,"1":-0.10018153479113338,"2":-0.008178336771837982,"3":0.06411384434659363,"4":-0.09632322489986782,"5":-0.1085379470599603,"6":0.15343288971836977,"7":0.11287968258798964,"8":0.09261894828681815,"9":0.05321856062022459,"10":0.10916715364667894,"11":-0.008209951494416426,"12":-0.0287681189627718,"13":0.1550242692026847,"14":0.1480494145127614,"15":-0.23684472381505314,"16":0.03375670102497797,"17":-0.05054383479546705,"18":0.12122815551240787,"19":0.0535341500148738,"20":0.12536883161576293,"21":0.10244566699511161,"22":-0.03659435471374528,"23":-0.13912882402170554,"24":-0.05489004035772625,"25":-0.011728174450142887,"26":-0.00828774934327073,"27":-0.1583963329556145,"28":0.021115009181176418,"29":0.07958703218583885,"30":0.021541273341485364,"31":0.04419555609370709,"32":-0.01972690927859478,"33":0.14746294377399238,"34":0.12282131575568736,"35":0.14515373480148924,"36":0.05966749204499774,"37":0.08459527311976096,"38":-0.1500527515834101,"39":0.009140714540470113,"40":0.0594957579583693,"41":0.031014735823954292,"42":-0.02038166097686192,"43":-0.2192553402124948,"44":-0.00516515393733145,"45":0.1482590435771939,"46":0.018587593493553517,"47":0.027429763476972582,"48":-0.022840862173371577,"49":-0.024565797221537303,"50":-0.0419296883757881,"51":-0.04700700710457935,"52":-0.11342704638595448,"53":-0.050292031979657356,"54":0.06239261772094414,"55":-0.22259965639442844,"56":0.037402945183939454,"57":-0.007201713307606181,"58":-0.049845296234761194,"59":-0.0354975106748929,"60":0.07542432314044425,"61":-0.03164598937930193,"62":-0.02084286675188318,"63":-0.03763285711189254,"64":-0.0442002577332769,"65":0.08115388010345022,"66":0.006446699053989714,"67":0.04003050857976947,"68":-0.07637209268201098,"69":-0.0640446653354123,"70":0.15995471515632909,"71":0.03605167417218069,"72":0.21266261368923503,"73":-0.08563406193676905,"74":0.15953163567422254,"75":-0.0673474893226765,"76":-0.08089429468943587,"77":0.042106071460195495,"78":-0.1423533311264935,"79":-0.046898030572499895,"80":0.036385484150241364,"81":0.07352586019873716,"82":-0.034440405836574935,"83":0.08594214264180296,"84":-0.01950933875719617,"85":-0.003962428926113102,"86":0.003554281444426533,"87":-0.15536321973376624,"88":0.14217824391882586,"89":-0.025888775909687727,"90":0.04376720361309168,"91":0.15332046534226054,"92":-0.05804569482759128,"93":0.07418826234276854,"94":-0.004287746170967385,"95":-0.05903435908295416,"96":0.005800077713549355,"97":-0.0784781906768153,"98":-0.0732717770469208,"99":0.15172850573987307,"100":0.0667259487625952,"101":-0.08554931989106976,"102":0.05448054837242198,"103":0.03786135870254064,"104":0.05669691029518348,"105":-0.052754149542617645,"106":0.10044867246879335,"107":0.011698740012531492,"108":-0.0006585669607439198,"109":-0.031124847634257997,"110":0.10719832809890162,"111":0.050512915231792826,"112":0.06245088742895375,"113":0.02069130141444118,"114":-0.10619502360428154,"115":0.10088058724254324,"116":0.09611599859381498,"117":0.05041243048235246,"118":-0.06330718050672879,"119":-0.09746988329893709,"120":0.11430585992467733,"121":-0.11361037785958318,"122":-0.29548651717811925}}],"biases":{"sx":1,"sy":1,"depth":5,"w":{"0":0.09697445937458586,"1":0.0949737791613539,"2":0.09187534119400714,"3":0.09776517539350334,"4":0.08797264381886512}}},{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"relu"},{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":5,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":5,"w":{"0":0.2477161758360179,"1":-0.29307938900727415,"2":0.7360766579481963,"3":1.0929032976842339,"4":-0.40215916435421867}},{"sx":1,"sy":1,"depth":5,"w":{"0":-0.6114023487085837,"1":-0.24877082428748776,"2":-0.24783666911156696,"3":1.3544676156949707,"4":-0.0815333209182788}},{"sx":1,"sy":1,"depth":5,"w":{"0":0.35518701992426444,"1":0.021632914589535538,"2":-0.44777993430404983,"3":0.8610341501372135,"4":-0.48067015356473203}},{"sx":1,"sy":1,"depth":5,"w":{"0":0.7660423410300208,"1":-0.8200919087622568,"2":0.1454485092168703,"3":0.9055766553563362,"4":-0.37376345724523363}},{"sx":1,"sy":1,"depth":5,"w":{"0":0.3406273361706227,"1":0.7058804773835041,"2":-0.4472032184453064,"3":1.0356387955269313,"4":-0.40506794502438603}}],"biases":{"sx":1,"sy":1,"depth":5,"w":{"0":-0.044162735989230276,"1":0.13257895822562568,"2":-0.032414450089413196,"3":0.18578646089893014,"4":0.2767075992867592}}},{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"regression","num_inputs":5}]});
}